# 架构调整篇
------------

| 时间        |  版本   |    内容  |    作者  |
| :--------: | :-----: | :----:  | :-----:  |
| 2015-5-24  |  0.1    |         | 林上耀   |

## 架构一：

### 软件架构

采用线程与采集通道`1 to 1 bind`，通过优先级来控制执行顺序，实际是serial而不是concurrent的架构。

### 存在问题：

1. 低效的设计
	线程绑定效率过低，多数线程处于睡眠状态，平白增加了系统load。
2. 容量弹性扩充能力有限：
	由于低效，和不易扩展的模式，使得修改子节点数影响整个系统，必须修改所有相关程序。随着节点数增加，性能下降严重。
3. 高耦合的架构
	采集，处理，数据发送功能都相互间高度耦合，通过单一互斥锁来对临界区进行访问控制，锁的粒度太粗，使得系统的性能差。而且三个功能间高度依赖，无法并发执行。
4. 架构不合理，无法实现期望的并发
	底层采集通道使用同一USB出口，实际就是串行共享的，采用的多采集线程无法同时并发以改善性能，所以实际模型仍是串行的，相反进行线程切换浪费了资源。

## 新架构二：

### 通过业务分割系统

改成了新模式，将整个系统分成了3个任务，其中每个任务对应1个线程。1个`collect`线程负责采集数据，1个`process`线程负责处理数据，1个`socket`线程负责发送网络数据。

### 优势：

1. 更高的性能和吞吐能力
	cpu利用率更高，三个任务进行分离后，三个任务可同时并发。具有高优先级的低cpu消耗的`collect`线程得以优先执行，保证采集能最快相应，减少延时，使得共享USB总线的利用率最高。而高cpu消耗的`process`线程具有最低优先级，只要在预定时间内执行完成即可。
2. 更低的模块耦合性
	将三个不同功能的模块进行了分割，通过消息队列和条件变量进行异步通知，通过接口通信，使得系统的耦合性更低。各个模块功能的更新和升级更加简易。
3. 更具弹性的伸缩
	无论系统节点数增减，系统的性能与节点数成比例，在cpu能力内不会剧烈下降。